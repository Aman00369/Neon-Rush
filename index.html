<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NEON RUSH</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap');
*{margin:0;padding:0;box-sizing:border-box;}
body{
  background:#050510;
  font-family:'Orbitron',monospace;
  color:#00f5ff;
  overflow:hidden;
  height:100vh;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  user-select:none;
}
body::before{
  content:'';
  position:fixed;inset:0;
  background-image:linear-gradient(rgba(0,245,255,0.04) 1px,transparent 1px),linear-gradient(90deg,rgba(0,245,255,0.04) 1px,transparent 1px);
  background-size:40px 40px;
  pointer-events:none;z-index:0;
}
#wrap{position:relative;z-index:1;display:flex;flex-direction:column;align-items:center;gap:0;}
#hud{
  width:860px;padding:8px 18px;
  background:rgba(0,2,15,0.9);
  border:1px solid #00f5ff;border-bottom:none;
  box-shadow:0 0 20px rgba(0,245,255,0.25);
  display:flex;justify-content:space-between;align-items:center;
}
.htitle{font-size:17px;font-weight:900;letter-spacing:5px;text-shadow:0 0 12px #00f5ff,0 0 30px #00f5ff;}
.hgroup{display:flex;gap:20px;align-items:center;}
.hitem{font-family:'Share Tech Mono',monospace;font-size:12px;letter-spacing:2px;display:flex;align-items:center;gap:5px;}
.hval{font-size:15px;font-weight:700;color:#ffd700;text-shadow:0 0 8px #ffd700;}
.hearts{display:flex;gap:3px;}
.heart{font-size:17px;filter:drop-shadow(0 0 5px #ff0080);transition:all 0.3s;}
.heart.dead{opacity:0.15;filter:none;}
canvas{display:block;border:1px solid #00f5ff;box-shadow:0 0 40px rgba(0,245,255,0.35),0 0 80px rgba(0,245,255,0.1);}
#foot{
  width:860px;padding:5px 18px;
  background:rgba(0,2,15,0.9);
  border:1px solid #00f5ff;border-top:none;
  display:flex;justify-content:space-between;align-items:center;
  font-family:'Share Tech Mono',monospace;font-size:10px;color:rgba(0,245,255,0.45);letter-spacing:2px;
}
#overlay{
  position:absolute;top:0;left:0;width:860px;height:500px;
  background:rgba(0,0,12,0.93);
  border:1px solid #00f5ff;
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:18px;
  z-index:20;
}
#overlay.hide{display:none;}
.otitle{
  font-size:54px;font-weight:900;letter-spacing:6px;
  color:#00f5ff;text-shadow:0 0 20px #00f5ff,0 0 60px #00f5ff;
  animation:glow 2s ease-in-out infinite;
}
.otitle.pink{color:#ff0080;text-shadow:0 0 20px #ff0080,0 0 60px #ff0080;}
.otitle.gold{color:#ffd700;text-shadow:0 0 20px #ffd700,0 0 60px #ffd700;}
@keyframes glow{0%,100%{opacity:1;}50%{opacity:0.75;}}
.osub{font-family:'Share Tech Mono',monospace;font-size:13px;letter-spacing:3px;color:rgba(0,245,255,0.7);}
.oinfo{font-size:11px;color:rgba(0,245,255,0.4);text-align:center;line-height:2.2;font-family:'Share Tech Mono',monospace;letter-spacing:1.5px;}
.oscore{font-size:26px;font-weight:700;color:#ffd700;text-shadow:0 0 12px #ffd700;letter-spacing:4px;}
.btn{
  padding:13px 42px;background:transparent;
  border:2px solid #00f5ff;color:#00f5ff;
  font-family:'Orbitron',monospace;font-size:13px;font-weight:700;
  letter-spacing:4px;cursor:pointer;
  transition:all 0.2s;box-shadow:0 0 15px rgba(0,245,255,0.25);
}
.btn:hover{background:rgba(0,245,255,0.1);box-shadow:0 0 30px rgba(0,245,255,0.55);transform:scale(1.04);}
</style>
</head>
<body>
<div id="wrap">
  <div id="hud">
    <div class="htitle">NEON RUSH</div>
    <div class="hgroup">
      <div class="hitem">LVL <span class="hval" id="hl">1</span></div>
      <div class="hitem">SCORE <span class="hval" id="hs">0</span></div>
      <div class="hitem">COINS <span class="hval" id="hc">0</span></div>
      <div class="hitem">
        <div class="hearts">
          <span class="heart" id="hh1">♥</span>
          <span class="heart" id="hh2">♥</span>
          <span class="heart" id="hh3">♥</span>
        </div>
      </div>
    </div>
  </div>
  <div style="position:relative;">
    <canvas id="c" width="860" height="500"></canvas>
    <div id="overlay">
      <div class="otitle">NEON RUSH</div>
      <div class="osub">CYBERPUNK PLATFORMER · 3 LEVELS</div>
      <div class="oinfo">
        ← → / A D &nbsp;·&nbsp; MOVE<br>
        SPACE / ↑ / W &nbsp;·&nbsp; JUMP &nbsp; (PRESS TWICE = DOUBLE JUMP)<br>
        STOMP ENEMIES FROM ABOVE · COLLECT COINS · REACH THE EXIT PORTAL
      </div>
      <button class="btn" id="startBtn">▶ START GAME</button>
    </div>
  </div>
  <div id="foot">
    <span>ARROW KEYS / WASD + SPACE TO JUMP</span>
    <span id="fps">FPS: --</span>
    <span>DOUBLE JUMP ENABLED</span>
  </div>
</div>

<script>
'use strict';
const cv=document.getElementById('c');
const cx=cv.getContext('2d');
const W=cv.width, H=cv.height;

const elLvl=document.getElementById('hl');
const elScore=document.getElementById('hs');
const elCoins=document.getElementById('hc');
const elFps=document.getElementById('fps');
const overlay=document.getElementById('overlay');

let STATE='start';
let score=0,totalCoins=0,lvl=1,hp=3;
const K={};

document.addEventListener('keydown',e=>{
  if(['Space','ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.code))e.preventDefault();
  if(!K[e.code]){
    K[e.code]=true;
    if(STATE==='playing'&&(e.code==='Space'||e.code==='ArrowUp'||e.code==='KeyW'))tryJump();
  }
});
document.addEventListener('keyup',e=>{K[e.code]=false;});

const GRAV=0.58, JFORCE=-12.5, SPD=4.8;
let P={};

function resetPlayer(){
  P={x:80,y:380,w:26,h:34,vx:0,vy:0,onGround:false,jumpsLeft:2,invTimer:0,facing:1,trail:[],animT:0};
}

function tryJump(){
  if(P.jumpsLeft>0){
    P.vy=JFORCE+(P.jumpsLeft<2?1.5:0);
    P.jumpsLeft--;
    spawnParts(P.x+P.w/2,P.y+P.h,'#00f5ff',5,2);
  }
}

const LEVEL_DATA=[
{
  plats:[
    {x:0,y:460,w:860,h:40,t:'ground'},
    {x:80,y:370,w:110,h:14,t:'n'},
    {x:250,y:305,w:100,h:14,t:'n'},
    {x:400,y:235,w:130,h:14,t:'n'},
    {x:580,y:295,w:100,h:14,t:'n'},
    {x:700,y:210,w:110,h:14,t:'n'},
    {x:180,y:205,w:80,h:14,t:'g'},
    {x:480,y:150,w:80,h:14,t:'g'},
  ],
  coins:[
    {x:110,y:343},{x:145,y:343},{x:275,y:278},{x:310,y:278},
    {x:430,y:208},{x:462,y:208},{x:494,y:208},{x:602,y:268},
    {x:635,y:268},{x:722,y:183},{x:754,y:183},{x:193,y:178},
    {x:225,y:178},{x:493,y:122},{x:518,y:122},
  ],
  enemies:[
    {x:260,y:432,w:28,h:28,vx:1.5,mn:80,mx:400,t:'b'},
    {x:600,y:432,w:28,h:28,vx:-1.5,mn:450,mx:800,t:'b'},
    {x:420,y:210,w:26,h:26,vx:1.2,mn:400,mx:530,t:'b'},
    {x:710,y:185,w:26,h:26,vx:-1.2,mn:700,mx:810,t:'f'},
  ],
  portal:{x:800,y:400},
},
{
  plats:[
    {x:0,y:460,w:240,h:40,t:'ground'},
    {x:310,y:460,w:160,h:40,t:'ground'},
    {x:560,y:460,w:300,h:40,t:'ground'},
    {x:60,y:375,w:90,h:14,t:'n'},
    {x:210,y:320,w:80,h:14,t:'mv',spd:1.8,dir:1,rng:70},
    {x:350,y:360,w:90,h:14,t:'n'},
    {x:480,y:275,w:75,h:14,t:'mv',spd:2.2,dir:-1,rng:60},
    {x:620,y:350,w:100,h:14,t:'n'},
    {x:755,y:255,w:80,h:14,t:'n'},
    {x:140,y:230,w:90,h:14,t:'g'},
    {x:420,y:180,w:75,h:14,t:'g'},
    {x:640,y:200,w:90,h:14,t:'g'},
    {x:280,y:140,w:55,h:14,t:'cr'},
    {x:530,y:125,w:55,h:14,t:'cr'},
  ],
  coins:[
    {x:80,y:348},{x:112,y:348},{x:362,y:333},{x:394,y:333},
    {x:635,y:323},{x:668,y:323},{x:770,y:228},{x:794,y:228},
    {x:150,y:203},{x:180,y:203},{x:210,y:203},{x:432,y:153},
    {x:460,y:153},{x:288,y:113},{x:540,y:98},
  ],
  enemies:[
    {x:80,y:432,w:28,h:28,vx:2,mn:0,mx:230,t:'b'},
    {x:330,y:432,w:28,h:28,vx:-2,mn:310,mx:460,t:'b'},
    {x:600,y:432,w:28,h:28,vx:1.8,mn:560,mx:855,t:'b'},
    {x:365,y:335,w:26,h:26,vx:1.5,mn:350,mx:440,t:'f'},
    {x:645,y:175,w:26,h:26,vx:-1.5,mn:640,mx:730,t:'f'},
    {x:215,y:295,w:26,h:26,vx:1.8,mn:140,mx:270,t:'f'},
  ],
  portal:{x:800,y:400},
},
{
  plats:[
    {x:0,y:460,w:130,h:40,t:'ground'},
    {x:200,y:460,w:90,h:40,t:'ground'},
    {x:380,y:460,w:70,h:40,t:'ground'},
    {x:560,y:460,w:300,h:40,t:'ground'},
    {x:50,y:375,w:70,h:14,t:'mv',spd:2,dir:1,rng:90},
    {x:190,y:340,w:55,h:14,t:'cr'},
    {x:330,y:300,w:70,h:14,t:'mv',spd:2.5,dir:-1,rng:75},
    {x:460,y:370,w:55,h:14,t:'cr'},
    {x:540,y:290,w:75,h:14,t:'n'},
    {x:665,y:360,w:75,h:14,t:'n'},
    {x:785,y:280,w:70,h:14,t:'g'},
    {x:110,y:260,w:75,h:14,t:'g'},
    {x:235,y:195,w:55,h:14,t:'mv',spd:2.8,dir:1,rng:110},
    {x:430,y:195,w:75,h:14,t:'g'},
    {x:620,y:195,w:75,h:14,t:'n'},
    {x:730,y:135,w:90,h:14,t:'g'},
    {x:390,y:115,w:70,h:14,t:'cr'},
    {x:165,y:125,w:55,h:14,t:'cr'},
  ],
  coins:[
    {x:65,y:348},{x:95,y:348},{x:345,y:273},{x:372,y:273},
    {x:553,y:263},{x:580,y:263},{x:798,y:253},{x:823,y:253},
    {x:123,y:233},{x:150,y:233},{x:441,y:168},{x:468,y:168},
    {x:495,y:168},{x:634,y:168},{x:660,y:168},{x:742,y:108},
    {x:768,y:108},{x:795,y:108},{x:398,y:88},{x:425,y:88},
    {x:172,y:98},{x:197,y:98},
  ],
  enemies:[
    {x:50,y:432,w:28,h:28,vx:2.5,mn:0,mx:120,t:'b'},
    {x:210,y:432,w:28,h:28,vx:-2,mn:200,mx:280,t:'b'},
    {x:390,y:432,w:28,h:28,vx:2.8,mn:380,mx:445,t:'f'},
    {x:580,y:432,w:28,h:28,vx:2.3,mn:560,mx:855,t:'b'},
    {x:548,y:265,w:26,h:26,vx:2,mn:540,mx:640,t:'f'},
    {x:672,y:335,w:26,h:26,vx:-2,mn:570,mx:740,t:'f'},
    {x:435,y:170,w:26,h:26,vx:2,mn:430,mx:505,t:'f'},
    {x:627,y:170,w:26,h:26,vx:2.3,mn:620,mx:695,t:'f'},
    {x:240,y:170,w:26,h:26,vx:2.8,mn:140,mx:290,t:'f'},
  ],
  portal:{x:800,y:400},
}
];

let plats=[],enemies=[],coins=[],portalO=null,parts=[],stars=[];

function buildLevel(){
  const D=LEVEL_DATA[lvl-1];
  resetPlayer();
  plats=D.plats.map(p=>({...p,ox:p.x,oy:p.y,crT:0,fallen:false}));
  enemies=D.enemies.map(e=>({...e,aT:0}));
  coins=D.coins.map(c=>({...c,got:false,bob:Math.random()*Math.PI*2}));
  portalO={...D.portal,w:36,h:48,t:0};
  parts=[];
  if(!stars.length) buildStars();
}

function buildStars(){
  stars=[];
  for(let i=0;i<110;i++) stars.push({x:Math.random()*W,y:Math.random()*H,r:Math.random()*1.4+0.3,s:Math.random()*0.4+0.15});
}

function spawnParts(x,y,col,n=8,spd=4){
  for(let i=0;i<n;i++){
    const a=Math.random()*Math.PI*2,s=Math.random()*spd+1;
    parts.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s-1.5,life:1,col,sz:Math.random()*4+1.5});
  }
}

function overlap(a,b){return a.x<b.x+b.w&&a.x+a.w>b.x&&a.y<b.y+b.h&&a.y+a.h>b.y;}

function resolvePlayer(){
  P.onGround=false;
  for(const p of plats){
    if(p.fallen)continue;
    if(!overlap(P,p))continue;
    const ol=P.x+P.w-p.x, or_=p.x+p.w-P.x, ot=P.y+P.h-p.y, ob=p.y+p.h-P.y;
    const mn=Math.min(ol,or_,ot,ob);
    if(mn===ot&&P.vy>=0){
      P.y=p.y-P.h; P.vy=0; P.onGround=true; P.jumpsLeft=2;
      if(p.t==='cr'&&p.crT===0) p.crT=0.01;
    } else if(mn===ob&&P.vy<0){P.y=p.y+p.h;P.vy=0;}
    else if(mn===ol){P.x=p.x-P.w;P.vx=0;}
    else if(mn===or_){P.x=p.x+p.w;P.vx=0;}
  }
}

function update(dt){
  if(STATE!=='playing')return;

  if(K['ArrowLeft']||K['KeyA']){P.vx=-SPD;P.facing=-1;}
  else if(K['ArrowRight']||K['KeyD']){P.vx=SPD;P.facing=1;}
  else P.vx=0;

  P.vy+=GRAV*dt;
  P.x+=P.vx*dt;
  P.y+=P.vy*dt;
  if(P.x<0)P.x=0;
  if(P.x+P.w>W)P.x=W-P.w;
  resolvePlayer();

  P.animT+=dt;
  P.trail.push({x:P.x+P.w/2,y:P.y+P.h/2});
  if(P.trail.length>10)P.trail.shift();
  if(P.invTimer>0)P.invTimer-=dt;
  if(P.y>H+60){loseHP(true);return;}

  for(const p of plats){
    if(p.t==='mv'){
      p.x+=p.spd*p.dir*dt;
      if(p.x>p.ox+p.rng||p.x<p.ox-p.rng)p.dir*=-1;
    }
    if(p.t==='cr'&&p.crT>0){
      p.crT+=dt;
      if(p.crT>45){p.y+=6*dt;if(p.y>H+100)p.fallen=true;}
    }
  }

  for(let i=enemies.length-1;i>=0;i--){
    const e=enemies[i];
    e.aT+=dt;
    e.x+=e.vx*dt;
    if(e.x<e.mn||e.x+e.w>e.mx)e.vx*=-1;
    if(P.invTimer<=0&&overlap(P,{x:e.x,y:e.y,w:e.w,h:e.h})){
      if(P.vy>0&&P.y+P.h<e.y+e.h*0.6){
        spawnParts(e.x+e.w/2,e.y,'#39ff14',12,5);
        enemies.splice(i,1);
        score+=200; P.vy=JFORCE*0.65;
        updHUD();
      } else {loseHP(false);}
    }
  }

  for(const s of stars){s.x-=s.s*0.4*dt;if(s.x<0)s.x=W;}

  for(const c of coins){
    c.bob+=0.05*dt;
    if(!c.got&&overlap(P,{x:c.x-10,y:c.y-10,w:20,h:20})){
      c.got=true;totalCoins++;score+=100;
      spawnParts(c.x,c.y,'#ffd700',14,5);updHUD();
    }
  }

  portalO.t+=0.045*dt;
  if(overlap(P,{x:portalO.x,y:portalO.y,w:portalO.w,h:portalO.h})){
    if(lvl<LEVEL_DATA.length){lvl++;score+=1000;doNextLevel();}
    else{STATE='win';showOv('win');}
  }

  // tick particles
  for(let i=parts.length-1;i>=0;i--){
    const p=parts[i];
    p.x+=p.vx*dt;p.y+=p.vy*dt;p.vy+=0.2*dt;p.life-=0.022*dt;
    if(p.life<=0)parts.splice(i,1);
  }
}

function loseHP(fell){
  if(P.invTimer>0)return;
  hp--;P.invTimer=90;
  spawnParts(P.x+P.w/2,P.y+P.h/2,'#ff0080',16,6);
  updHUD();
  if(hp<=0){spawnParts(P.x+P.w/2,P.y+P.h/2,'#ff0080',30,8);STATE='dead';showOv('dead');}
  else if(fell){P.x=80;P.y=380;P.vy=0;P.vx=0;}
}

function updHUD(){
  elLvl.textContent=lvl;elScore.textContent=score;elCoins.textContent=totalCoins;
  for(let i=1;i<=3;i++)document.getElementById('hh'+i).classList.toggle('dead',i>hp);
}

function showOv(mode){
  overlay.classList.remove('hide');
  if(mode==='nextlevel'){
    overlay.innerHTML=`<div class="otitle">LEVEL ${lvl}</div><div class="osub">ZONE ${lvl} UNLOCKED</div><div class="oscore">+1000 PTS</div><button class="btn" id="ob">▶ CONTINUE</button>`;
    document.getElementById('ob').onclick=function(){overlay.classList.add('hide');buildLevel();updHUD();STATE='playing';};
  } else if(mode==='dead'){
    overlay.innerHTML=`<div class="otitle pink">GAME OVER</div><div class="oscore">SCORE: ${score}</div><div class="oscore" style="font-size:18px;color:#00f5ff">COINS: ${totalCoins}</div><button class="btn" id="ob">↺ RETRY</button>`;
    document.getElementById('ob').onclick=function(){score=0;totalCoins=0;lvl=1;hp=3;overlay.classList.add('hide');buildLevel();updHUD();STATE='playing';};
  } else if(mode==='win'){
    overlay.innerHTML=`<div class="otitle gold">YOU WIN!</div><div class="oscore">FINAL SCORE: ${score}</div><div class="oscore" style="font-size:18px;color:#39ff14">COINS: ${totalCoins}</div><button class="btn" id="ob">▶ PLAY AGAIN</button>`;
    document.getElementById('ob').onclick=function(){score=0;totalCoins=0;lvl=1;hp=3;overlay.classList.add('hide');buildLevel();updHUD();STATE='playing';};
  }
}

function doNextLevel(){
  STATE='nextlevel';showOv('nextlevel');
}

// Draw
const PS={ground:{fill:'#081830',top:'#00f5ff',glow:'rgba(0,245,255,0.35)'},n:{fill:'#0a1030',top:'#3388ff',glow:'rgba(51,136,255,0.4)'},g:{fill:'#180a28',top:'#ff0080',glow:'rgba(255,0,128,0.5)'},mv:{fill:'#082018',top:'#39ff14',glow:'rgba(57,255,20,0.5)'},cr:{fill:'#1c0a06',top:'#ff6600',glow:'rgba(255,100,0,0.45)'}};

function drawBG(){
  const pals=[['#040410','#080420'],['#080412','#100418'],['#100408','#180410']];
  const c=pals[Math.min(lvl-1,2)];
  const g=cx.createLinearGradient(0,0,0,H);
  g.addColorStop(0,c[0]);g.addColorStop(1,c[1]);
  cx.fillStyle=g;cx.fillRect(0,0,W,H);
  cx.shadowBlur=5;
  for(const s of stars){
    cx.fillStyle=`rgba(0,245,255,${0.25+0.4*Math.abs(Math.sin(s.x*0.08))})`;
    cx.shadowColor='#00f5ff';
    cx.beginPath();cx.arc(s.x,s.y,s.r,0,Math.PI*2);cx.fill();
  }
  cx.shadowBlur=0;
}

function drawPlat(p){
  if(p.fallen)return;
  const s=PS[p.t]||PS.n;
  let a=1;
  if(p.t==='cr'&&p.crT>0)a=Math.max(0,1-p.crT/60);
  cx.globalAlpha=a;
  let ox=0,oy=0;
  if(p.t==='cr'&&p.crT>0&&p.crT<45){ox=(Math.random()-0.5)*p.crT*0.15;oy=(Math.random()-0.5)*p.crT*0.08;}
  cx.save();cx.translate(ox,oy);
  cx.shadowBlur=18;cx.shadowColor=s.glow;cx.fillStyle=s.fill;cx.fillRect(p.x,p.y,p.w,p.h);
  cx.shadowBlur=10;cx.shadowColor=s.top;cx.fillStyle=s.top;cx.fillRect(p.x,p.y,p.w,3);
  cx.fillStyle=s.glow;
  if(p.w>40)for(let x=p.x+12;x<p.x+p.w-10;x+=18)cx.fillRect(x,p.y+5,1.5,p.h-8);
  cx.restore();cx.globalAlpha=1;cx.shadowBlur=0;
}

function drawEnemy(e){
  const t=e.aT/60;
  const isF=e.t==='f';
  const col=isF?'#ff0080':'#ff4400';
  const glo=isF?'rgba(255,0,128,0.7)':'rgba(255,68,0,0.6)';
  cx.save();cx.translate(e.x+e.w/2,e.y+e.h/2);
  if(e.vx<0)cx.scale(-1,1);
  cx.shadowBlur=18;cx.shadowColor=glo;cx.fillStyle=col;
  cx.fillRect(-e.w/2,-e.h/2,e.w,e.h);
  cx.shadowBlur=8;cx.shadowColor='#fff';cx.fillStyle='#fff';
  cx.fillRect(-e.w/2+5,-e.h/2+7,5,5);cx.fillRect(-e.w/2+e.w-10,-e.h/2+7,5,5);
  cx.fillStyle='#111';cx.fillRect(-e.w/2+7,-e.h/2+9,2,2);cx.fillRect(-e.w/2+e.w-8,-e.h/2+9,2,2);
  cx.strokeStyle=col;cx.lineWidth=1.5;cx.shadowBlur=4;
  const bop=Math.sin(t*8)*3;
  cx.beginPath();cx.moveTo(0,-e.h/2);cx.lineTo(0,-e.h/2-7+bop);cx.stroke();
  cx.fillStyle='#ffd700';cx.shadowColor='#ffd700';cx.shadowBlur=8;
  cx.beginPath();cx.arc(0,-e.h/2-7+bop,2.5,0,Math.PI*2);cx.fill();
  const leg=Math.sin(t*10)*4;
  cx.fillStyle=col;cx.shadowBlur=4;cx.shadowColor=glo;
  cx.fillRect(-e.w/2,e.h/2-4,7,5+(leg>0?leg:0));cx.fillRect(e.w/2-7,e.h/2-4,7,5+(leg<0?-leg:0));
  cx.restore();cx.shadowBlur=0;
}

function drawPlayer(){
  const t=P.animT/60;
  const blink=P.invTimer>0&&(Math.floor(P.invTimer/6)%2===0);
  // trail
  for(let i=0;i<P.trail.length;i++){
    const tr=P.trail[i],a=(i/P.trail.length)*0.35;
    cx.globalAlpha=blink?0:a;
    cx.fillStyle='#00f5ff';cx.shadowBlur=8;cx.shadowColor='#00f5ff';
    const sz=(i/P.trail.length)*7;
    cx.fillRect(tr.x-sz/2,tr.y-sz/2,sz,sz);
  }
  cx.globalAlpha=blink?0.25:1;cx.shadowBlur=0;
  cx.save();cx.translate(P.x+P.w/2,P.y+P.h/2);
  if(P.facing<0)cx.scale(-1,1);
  cx.shadowBlur=22;cx.shadowColor='#00f5ff';
  cx.fillStyle='#003355';cx.fillRect(-P.w/2,-P.h/2,P.w,P.h);
  cx.strokeStyle='#00f5ff';cx.lineWidth=1.5;cx.shadowBlur=6;
  cx.strokeRect(-P.w/2+3,-P.h/2+3,P.w-6,P.h-6);
  cx.beginPath();cx.moveTo(-P.w/2+3,2);cx.lineTo(P.w/2-3,2);cx.stroke();
  cx.fillStyle='#00f5ff';cx.shadowBlur=14;cx.fillRect(-P.w/2+4,-P.h/2+3,P.w-8,11);
  cx.fillStyle='rgba(0,20,50,0.85)';cx.fillRect(-P.w/2+6,-P.h/2+5,P.w-12,7);
  cx.fillStyle='rgba(0,245,255,0.55)';cx.fillRect(-P.w/2+6,-P.h/2+5,4,3);
  cx.fillStyle='#001a2a';cx.shadowBlur=4;cx.fillRect(P.w/2-4,-P.h/4,7,P.h/2);
  if(P.vy<-1.5){
    const fl=5+Math.random()*5;
    cx.fillStyle='#ff8800';cx.shadowColor='#ff8800';cx.shadowBlur=15;
    cx.beginPath();cx.moveTo(P.w/2-2,P.h/4);cx.lineTo(P.w/2+5,P.h/4);cx.lineTo(P.w/2+1,P.h/4+fl);cx.closePath();cx.fill();
  }
  const moving=(K['ArrowLeft']||K['KeyA']||K['ArrowRight']||K['KeyD'])&&P.onGround;
  const leg=moving?Math.sin(t*14)*5:0;
  cx.fillStyle='#00aacc';cx.shadowColor='#00f5ff';cx.shadowBlur=5;
  cx.fillRect(-P.w/2+2,P.h/2-9,9,10+leg);cx.fillRect(P.w/2-11,P.h/2-9,9,10-leg);
  cx.fillStyle='#005580';cx.fillRect(-P.w/2+2,P.h/2+leg+1,9,5);cx.fillRect(P.w/2-11,P.h/2-leg+1,9,5);
  const arm=moving?Math.sin(t*14)*5:0;
  cx.fillStyle='#00aacc';cx.shadowBlur=4;
  cx.fillRect(-P.w/2-6,-P.h/4+arm,7,13);cx.fillRect(P.w/2-1,-P.h/4-arm,7,13);
  cx.restore();cx.globalAlpha=1;cx.shadowBlur=0;
}

function drawCoin(c){
  if(c.got)return;
  cx.save();cx.translate(c.x,c.y+Math.sin(c.bob)*3);cx.rotate(c.bob*0.5);
  cx.shadowBlur=14;cx.shadowColor='#ffd700';cx.fillStyle='#ffd700';
  cx.beginPath();cx.arc(0,0,8,0,Math.PI*2);cx.fill();
  cx.fillStyle='#cc8800';cx.beginPath();cx.arc(0,0,4.5,0,Math.PI*2);cx.fill();
  cx.fillStyle='rgba(255,255,180,0.65)';cx.fillRect(-1.5,-6,2.5,4);
  cx.restore();cx.shadowBlur=0;
}

function drawPortal(){
  const po=portalO;
  cx.save();cx.translate(po.x+po.w/2,po.y+po.h/2);
  for(let i=3;i>0;i--){
    cx.shadowBlur=25*i;cx.shadowColor='#00f5ff';
    cx.strokeStyle=`rgba(0,245,255,${0.25/i})`;cx.lineWidth=4*i;
    cx.beginPath();cx.ellipse(0,0,po.w/2+i*9,po.h/2+i*6,0,0,Math.PI*2);cx.stroke();
  }
  for(let r=0;r<3;r++){
    cx.save();cx.rotate(po.t*(1+r*0.4)+(r*Math.PI*2/3));
    cx.shadowBlur=14;cx.shadowColor='#39ff14';cx.strokeStyle='rgba(57,255,20,0.8)';cx.lineWidth=1.8;
    cx.setLineDash([7,7]);cx.beginPath();cx.ellipse(0,0,po.w/2+r*7,po.h/2+r*5,0,0,Math.PI*2);cx.stroke();
    cx.setLineDash([]);cx.restore();
  }
  const ig=cx.createRadialGradient(0,0,0,0,0,po.w/2);
  ig.addColorStop(0,'rgba(0,245,255,0.55)');ig.addColorStop(0.5,'rgba(0,80,140,0.35)');ig.addColorStop(1,'rgba(0,0,40,0.1)');
  cx.fillStyle=ig;cx.shadowBlur=18;cx.shadowColor='#00f5ff';
  cx.beginPath();cx.ellipse(0,0,po.w/2,po.h/2,0,0,Math.PI*2);cx.fill();
  cx.shadowBlur=8;cx.shadowColor='#ffd700';cx.fillStyle='#ffd700';
  cx.font='bold 8px Orbitron';cx.textAlign='center';cx.fillText('EXIT',0,po.h/2+14);
  cx.restore();cx.shadowBlur=0;
}

function render(){
  cx.clearRect(0,0,W,H);
  drawBG();
  cx.strokeStyle='rgba(0,245,255,0.03)';cx.lineWidth=1;
  for(let x=0;x<W;x+=40){cx.beginPath();cx.moveTo(x,0);cx.lineTo(x,H);cx.stroke();}
  for(let y=0;y<H;y+=40){cx.beginPath();cx.moveTo(0,y);cx.lineTo(W,y);cx.stroke();}
  if(STATE!=='start'){
    plats.forEach(drawPlat);
    coins.forEach(drawCoin);
    drawPortal();
    enemies.forEach(drawEnemy);
    drawPlayer();
    for(const p of parts){
      cx.globalAlpha=p.life;cx.fillStyle=p.col;cx.shadowBlur=7;cx.shadowColor=p.col;
      cx.beginPath();cx.arc(p.x,p.y,p.sz*p.life,0,Math.PI*2);cx.fill();
    }
    cx.globalAlpha=1;cx.shadowBlur=0;
  }
  cx.fillStyle='rgba(0,0,0,0.04)';
  for(let y=0;y<H;y+=3)cx.fillRect(0,y,W,1);
  if(STATE==='playing'){
    cx.fillStyle='rgba(0,245,255,0.055)';cx.font='bold 160px Orbitron';cx.textAlign='center';cx.fillText('L'+lvl,W/2,H-20);
  }
}

let lastT=0,fF=0,fT=0;
function loop(ts){
  requestAnimationFrame(loop);
  const dt=Math.min((ts-(lastT||ts))/16.67,3.5);
  lastT=ts;
  fF++;
  if(ts-fT>600){elFps.textContent='FPS:'+Math.round(fF*1000/(ts-fT));fF=0;fT=ts;}
  update(dt);
  render();
}

// Start button
document.getElementById('startBtn').onclick=function(){
  overlay.classList.add('hide');
  score=0;totalCoins=0;lvl=1;hp=3;
  buildLevel();updHUD();
  STATE='playing';
};

buildStars();
requestAnimationFrame(loop);
</script>
</body>
</html>